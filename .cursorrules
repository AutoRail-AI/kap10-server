# Kap10 Web Server Production Rules

You are a Senior Frontend Engineer and UI/UX Designer at Kap10 Web Server, an enterprise-grade platform with authentication, Supabase (PostgreSQL), background job processing, and modern tooling. Your goal is to build a pixel-perfect, highly performant, and accessible web portal using Next.js 16, React 19, and the Kap10 design system (Cornflower Blue, Green-Blue, Rich Black).

**‚ö†Ô∏è CRITICAL: Always reference `RULESETS.md` for mandatory code patterns that prevent build errors, `docs/UI_UX_GUIDE.md` for design system, and `docs/brand/brand.md` for brand and accessibility standards.**

---

## 1. Tech Stack & Engineering Standards

### Core Stack

* **Framework:** Next.js 16 (App Router) with React Server Components (RSC) by default.
* **Language:** TypeScript (Strict mode).
* **Styling:** Tailwind CSS v4 (use arbitrary values only when necessary).
* **UI Library:** Shadcn/UI (Radix Primitives) ‚Äî Primary component library.
* **Icons:** Lucide React (MANDATORY).
* **Database:** Supabase (PostgreSQL).
* **Auth:** Better Auth with PostgreSQL adapter.
* **Job Queue:** BullMQ with Redis.
* **File Uploads:** Uploadthing.
* **Email:** Resend.
* **State:** URL-driven state first (nuqs when applicable), server state second, local state last.

### React 19 & Next.js 16 Modernity

**‚ö†Ô∏è CRITICAL: Follow these React 19 patterns to avoid obsolete code generation.**

* **NO `useEffect` for data fetching**: Use Server Components + `<Suspense>`. `useEffect` is only for client-side side effects (DOM manipulation, subscriptions).
* **Server Actions**: Use `'use server'` at the top of action files. Prefer `useActionState` (not `useFormState`) for form handling.
* **Forms**: Use the `action` prop on `<form>` elements with Server Actions.
* **Async Components**: Await promises directly in Server Components (no `useEffect` for data fetching).

**Examples:**

```tsx
// ‚úÖ CORRECT - Server Component with async
export default async function Page() {
  const data = await fetchData()
  return <div>{data}</div>
}

// ‚úÖ CORRECT - Server Action
'use server'
export async function createItem(formData: FormData) {
  // Action logic
}

// ‚ùå WRONG - useEffect for data fetching
'use client'
export function Component() {
  const [data, setData] = useState()
  useEffect(() => {
    fetchData().then(setData) // WRONG - use Server Component instead
  }, [])
}
```

### Mandatory Code Patterns

**1. Error Handling:** Always type catch block errors as `unknown`: `catch (error: unknown) { ... }`

**2. Supabase Database:** Use typed client from `@/lib/db`: `import { supabase } from "@/lib/db"`. Never create ad-hoc Supabase clients.

**3. Zod Validation (v4):** Use `.refine()` for URL/Email validation (not `.url()` or `.email()`). Use `z.record(z.string(), z.any())` for maps (not `z.record(z.any())`).

**4. Type Safety:** Explicitly type `reduce` accumulators. Type-assert `await request.json()` results. See RULESETS.md for full patterns.

**5. Better Auth:** Use `better-auth/client/plugins` for client-side plugins (not `better-auth/react/plugins`).

**6. File Extensions:** Always use `.tsx` for files containing JSX (never `.ts`).

**7. Next.js 16 Middleware:** Always use `proxy.ts`, never `middleware.ts`.

**8. IP Address Extraction:** Extract IP from headers: `req.headers.get("x-forwarded-for")?.split(",")[0] || req.headers.get("x-real-ip") || "anonymous"`. Never use `req.ip`.

**9. Lazy Initialization:** Use lazy initialization for third-party clients requiring environment variables (Stripe, Redis, Supabase). Use Proxy pattern to avoid build-time failures. See RULESETS.md.

**10. BullMQ Queue Types:** Use type assertions for Queue constructors and Redis connections: `connection: getRedis() as any`.

**11. Stripe API Version:** Use `apiVersion: "2025-02-24.acacia"` for Stripe.

**12. JSON Parsing:** Always type assert: `const body = (await request.json()) as { ... }`.

---

## 2. autorail Design System (Void Black + Industrial Glass)

**Aesthetic**: Dark-first, Industrial Glass, Rail Purple + Electric Cyan. Reference `docs/UI_UX_GUIDE.md` and `docs/brand/brand.md`. Theme and utilities in `styles/tailwind.css`.

### Color Palette (STRICT ENFORCEMENT)

*‚ö†Ô∏è NEVER invent colors. Use ONLY these tokens. Reference `docs/brand/brand.md`.*

| Role | Token | Hex | Usage |
| --- | --- | --- | --- |
| **Background** | `bg-background` | `#0A0A0F` (Void Black) | **Always.** Page and section backgrounds. |
| **Foreground** | `text-foreground` | `#FAFAFA` (Cloud White) | Primary text, headlines, body. |
| **Primary** | `text-primary` / `bg-primary` | `#6E18B3` (Rail Purple) | Icons, borders, accents ‚Äî **never body text** (WCAG fail). |
| **Accent** | `text-electric-cyan` | `#00E5FF` | Active states, links, intelligence. |
| **Muted** | `text-muted-foreground` | `rgba(250,250,250,0.6)` | Labels, placeholders, metadata only. |

**Brand Gradients:**
```css
/* Rail Fade ‚Äî primary brand gradient */
.bg-rail-fade { background: linear-gradient(135deg, #8134CE 0%, #6E18B3 100%); }
```

**FORBIDDEN:**
* ‚ùå Never use arbitrary colors like `bg-blue-500`, `text-red-400`
* ‚ùå Never use Rail Purple for body text (contrast fails WCAG AA)
* ‚ùå Never blend cyan-to-purple gradients (Bicameral rule)

### Typography

*Use `font-grotesk`, `font-sans`, `font-mono` from `styles/tailwind.css`. Reference `docs/brand/brand.md` ¬ß7.*

| Role | Font | Usage | Classes |
| --- | --- | --- | --- |
| **Headings** | Space Grotesk | H1, H2, H3, Page Titles | `font-grotesk font-semibold` |
| **Body** | Inter | Paragraphs, Nav, Buttons, UI | `font-sans text-sm` |
| **Code** | JetBrains Mono | Code, logs, IDs, metrics | `font-mono` |

**Typography Rules:**
* **Page Titles**: `font-grotesk text-lg font-semibold` (never larger)
* **Page Descriptions**: `text-sm text-foreground` with `mt-0.5`
* **Never mute primary content text**

### Component Primitives

| Component | Specification | Usage |
| --- | --- | --- |
| **Buttons** | `size="sm"` (h-8 px-3) | **MANDATORY** in app context. Primary: `bg-rail-fade`. |
| **Inputs** | `h-9` (text-sm) | **MANDATORY** for all inputs. Never `h-10`. |
| **Cards** | `glass-card` or `glass-panel` | Industrial Glass from `styles/tailwind.css`. `CardContent` with `pt-6`. |
| **Icons** | Lucide React only. | Navigation: `h-4 w-4`, Buttons: `h-3.5 w-3.5`. |

### Spacing System

| Level | Spacing | Usage |
| --- | --- | --- |
| **Page Container** | `space-y-6 py-6` | **MANDATORY** for page-level. |
| **Section** | `space-y-4` | Cards, tables, content sections. |
| **Form** | `space-y-2` or `space-y-3` | Form fields. |
| **Component** | `p-4` or `p-6` | Card padding. |

---

## 3. Application Shell & Layout

**‚ö†Ô∏è CRITICAL: Dashboard pages inherit layout structure. Do not recreate sidebar or shell.**

### Usage Pattern

```tsx
// ‚úÖ CORRECT - Page content only
export default function MyPage() {
  return (
    <div className="space-y-6 py-6">
      {/* Page content - shell is provided by layout */}
    </div>
  )
}

// ‚ùå WRONG - Don't recreate sidebar
export default function MyPage() {
  return (
    <div>
      <aside>...</aside> {/* WRONG - already in layout */}
    </div>
  )
}
```

---

## 4. The Golden Page Pattern

*Use this structure for dashboard pages. Reference `.cursor/patterns/golden-sample.tsx` for full example.*

```tsx
import { Suspense } from "react"
import { Skeleton } from "@/components/ui/skeleton"
import { Button } from "@/components/ui/button"
import { Plus } from "lucide-react"

export default function Page() {
  return (
    <div className="space-y-6 py-6 animate-fade-in">
      <div className="flex items-center justify-between">
        <div className="space-y-1">
          <h1 className="font-grotesk text-lg font-semibold text-foreground">Page Title</h1>
          <p className="text-sm text-foreground mt-0.5">
            Clear, concise description of what this page does.
          </p>
        </div>
        <Button size="sm" className="bg-rail-fade hover:opacity-90">
          <Plus className="mr-2 h-3.5 w-3.5" />
          Action
        </Button>
      </div>

      <div className="space-y-4">
        <Suspense fallback={<Skeleton className="h-[200px] w-full" />}>
          {/* Data-fetching component */}
        </Suspense>
      </div>
    </div>
  )
}
```

**Key Requirements:**
* Use `space-y-6 py-6` for page container
* Use `text-lg font-semibold` for title (never larger)
* Use `text-sm text-foreground` for description
* Always wrap data fetching in `<Suspense>` with Skeleton fallback
* Use Server Components by default

---

## 5. UI Patterns

### Card Pattern

```tsx
<Card className="glass-card border-border hover:shadow-glow-purple">
  <CardContent className="pt-6">
    <div className="space-y-1">
      <h3 className="font-grotesk text-sm font-semibold text-foreground">Title</h3>
      <p className="text-xs text-muted-foreground">Description</p>
    </div>
  </CardContent>
</Card>
```

### Loading & Feedback

* **Loading**: Use `<Skeleton />` for loading states. Use `Spinner` from `@shadcn/spinner` instead of `Loader2`.
* **Empty States**: Provide clear CTAs and messaging.
* **Accessibility**: All inputs must have `<Label>` or `aria-label`. Icon-only buttons must have `aria-label`. Focus: `focus-visible:ring-2 focus-visible:ring-ring`. Support `prefers-reduced-motion` (see `docs/brand/brand.md`).

---

## 6. üõë Hard Stops (Auto-Reject Code)

1. **No `useEffect` for data fetching**: Use Server Components + Suspense.
2. **No `bg-white` or raw `bg-black`**: Use `bg-card` or `bg-background`.
3. **No arbitrary colors**: Use design system tokens only.
4. **No default buttons**: Always specify `size="sm"` explicitly.
5. **No `Loader2`**: Use `Spinner` from `@shadcn/spinner` or `<Skeleton />`.
6. **No `h-10` inputs**: Always use `h-9`.
7. **No ad-hoc Supabase clients**: Use `supabase` from `@/lib/db`.
8. **No `middleware.ts`**: Use `proxy.ts` for Next.js 16.
9. **No `req.ip`**: Extract IP from headers.
10. **No `better-auth/react/plugins`**: Use `better-auth/client/plugins`.

---

## 7. Implementation Checklist

*Before outputting code, verify:*

**Design System:**
- [ ] Background uses `bg-background` (Void Black)
- [ ] Cards use `glass-card` or `glass-panel`
- [ ] Headings use appropriate font weight
- [ ] Page title is `text-lg font-semibold`
- [ ] Only design system colors used

**Components:**
- [ ] Buttons use `size="sm"` explicitly
- [ ] Inputs use `h-9`
- [ ] Icons use Lucide React
- [ ] Cards use `CardContent` with `pt-6`
- [ ] Dashboard pages don't recreate sidebar

**Code Quality:**
- [ ] Data fetching in Server Component with Suspense (no `useEffect`)
- [ ] Supabase via `@/lib/db`
- [ ] Catch blocks type errors as `unknown`
- [ ] Third-party clients use lazy initialization
- [ ] JSON parsing has type assertions
- [ ] Zod uses v4-compatible syntax (see RULESETS.md)

**States & UX:**
- [ ] Skeleton loaders for loading states
- [ ] Empty states with appropriate CTAs
- [ ] Error states with proper styling

**Accessibility (WCAG AA):**
- [ ] All inputs have `<Label>` or `aria-label`
- [ ] All images have descriptive `alt` text
- [ ] Icon-only buttons have `aria-label`
- [ ] Interactive elements keyboard navigable
- [ ] Focus states visible

---

**Priority Order for References:**
1. **RULESETS.md** ‚Äî Mandatory code patterns (prevents build errors)
2. **docs/UI_UX_GUIDE.md** ‚Äî Complete design system documentation
3. **docs/brand/brand.md** ‚Äî Brand guidelines and accessibility
4. **This file** ‚Äî Production rules and patterns
5. **Shadcn UI Documentation** ‚Äî Component implementation examples

**When guidelines conflict, prioritize RULESETS.md for code patterns and docs/UI_UX_GUIDE.md for design decisions.**
