// Prisma schema for unerr app tables (Phase 0 + Phase 2 + Phase 3).
// All unerr-managed tables live in PostgreSQL schema "unerr" (same Supabase project, multi-app).
// Better Auth tables (user, session, account, etc.) stay in "public"; we do not migrate those.

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  schemas    = ["public", "unerr"]
  extensions = [vector(map: "vector", schema: "extensions")]
}

enum RepoStatus {
  pending
  indexing
  embedding
  ready
  error
  embed_failed
  deleting
  // Phase 4: Justification pipeline
  justifying
  justify_failed

  @@schema("unerr")
}

enum RepoProvider {
  github
  local_cli

  @@schema("unerr")
}

// Phase 1: GitHub App installation per org (installation token fetched on demand)
model GitHubInstallation {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  installationId  BigInt    @map("installation_id")
  accountLogin    String    @map("account_login")
  accountType     String    @map("account_type")
  permissions     Json?
  suspendedAt     DateTime? @map("suspended_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([organizationId, installationId])
  @@index([organizationId])
  @@map("github_installations")
  @@schema("unerr")
}

model Repo {
  id              String      @id @default(uuid())
  organizationId  String      @map("organization_id")
  name            String
  fullName        String      @map("full_name")
  provider        RepoProvider
  providerId      String      @map("provider_id")
  status         RepoStatus   @default(pending)
  defaultBranch  String       @default("main") @map("default_branch")
  lastIndexedAt   DateTime?   @map("last_indexed_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  // Phase 1 indexing fields
  githubRepoId    BigInt?     @map("github_repo_id")
  githubFullName  String?     @map("github_full_name")
  lastIndexedSha  String?     @map("last_indexed_sha")
  indexProgress   Int         @default(0) @map("index_progress")
  fileCount       Int         @default(0) @map("file_count")
  functionCount   Int         @default(0) @map("function_count")
  classCount      Int         @default(0) @map("class_count")
  errorMessage    String?     @map("error_message")
  workflowId      String?     @map("workflow_id")
  // Phase 2: Auto-PR onboarding fields
  onboardingPrUrl    String?  @map("onboarding_pr_url")
  onboardingPrNumber Int?     @map("onboarding_pr_number")
  // Phase 5: Incremental indexing fields
  webhookSecret       String?  @map("webhook_secret")
  incrementalEnabled  Boolean  @default(true) @map("incremental_enabled")
  // Phase 5.5: Local CLI fields
  localCliUploadPath String?  @map("local_cli_upload_path")
  // Phase 5.6: Ephemeral sandbox
  ephemeral          Boolean  @default(false)
  ephemeralExpiresAt DateTime? @map("ephemeral_expires_at")
  // Phase 2: Relations
  apiKeys           ApiKey[]
  // Phase 3: Embeddings relation
  entityEmbeddings  EntityEmbedding[]
  // Phase 5.5: Ledger snapshots relation
  ledgerSnapshots   LedgerSnapshot[]

  @@unique([organizationId, provider, providerId])
  @@index([organizationId])
  @@map("repos")
  @@schema("unerr")
}

enum DeletionLogStatus {
  pending
  in_progress
  completed
  failed

  @@schema("unerr")
}

model DeletionLog {
  id                 String            @id @default(uuid())
  organizationId     String            @map("organization_id")
  repoId             String?           @map("repo_id")
  requestedAt        DateTime          @default(now()) @map("requested_at")
  completedAt       DateTime?         @map("completed_at")
  entitiesDeleted    Int               @default(0) @map("entities_deleted")
  embeddingsDeleted  Int               @default(0) @map("embeddings_deleted")
  status             DeletionLogStatus  @default(pending)
  errorMessage       String?           @map("error_message")

  @@index([organizationId])
  @@index([status])
  @@map("deletion_logs")
  @@schema("unerr")
}

// Phase 2: API keys for MCP server access (org-level or repo-scoped)
model ApiKey {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  repoId          String?   @map("repo_id")
  name            String
  keyPrefix       String    @map("key_prefix")
  keyHash         String    @map("key_hash")
  scopes          String[]  @default(["mcp:read"])
  isDefault       Boolean   @default(false) @map("is_default")
  lastUsedAt      DateTime? @map("last_used_at")
  revokedAt       DateTime? @map("revoked_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  repo            Repo?     @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyHash])
  @@index([repoId])
  @@map("api_keys")
  @@schema("unerr")
}

// Phase 2: Shadow workspace overlay (per-user, per-repo, per-branch)
model Workspace {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  repoId      String    @map("repo_id")
  branch      String
  baseSha     String?   @map("base_sha")
  lastSyncAt  DateTime? @map("last_sync_at")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([userId, repoId, branch])
  @@index([expiresAt])
  @@map("workspaces")
  @@schema("unerr")
}

// Phase 10a: Graph snapshot status for local-first intelligence proxy
enum SnapshotStatus {
  generating
  available
  failed

  @@schema("unerr")
}

model GraphSnapshotMeta {
  id            String         @id @default(uuid())
  orgId         String         @map("org_id")
  repoId        String         @unique @map("repo_id")
  status        SnapshotStatus @default(generating)
  checksum      String?        @map("checksum")
  storagePath   String?        @map("storage_path")
  sizeBytes     Int            @default(0) @map("size_bytes")
  entityCount   Int            @default(0) @map("entity_count")
  edgeCount     Int            @default(0) @map("edge_count")
  generatedAt   DateTime?      @map("generated_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@index([orgId])
  @@map("graph_snapshot_meta")
  @@schema("unerr")
}

// Phase 3: Entity embeddings for semantic search (pgvector)
// model_version enables zero-downtime blue/green re-embedding on model upgrades
model EntityEmbedding {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  repoId        String    @map("repo_id")
  entityKey     String    @map("entity_key")
  entityType    String    @map("entity_type")
  entityName    String    @map("entity_name")
  filePath      String    @map("file_path")
  textContent   String    @map("text_content")
  modelVersion  String    @default("nomic-v1.5-768") @map("model_version")
  embedding     Unsupported("vector(768)")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  repo          Repo      @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@unique([repoId, entityKey, modelVersion])
  @@index([orgId, repoId])
  @@index([modelVersion])
  @@map("entity_embeddings")
  @@schema("unerr")
}

// Phase 4: Justification embeddings for semantic business-purpose search (pgvector)
model JustificationEmbedding {
  id              String    @id @default(uuid())
  orgId           String    @map("org_id")
  repoId          String    @map("repo_id")
  entityId        String    @map("entity_id")
  entityName      String    @map("entity_name")
  taxonomy        String
  featureTag      String    @map("feature_tag")
  businessPurpose String    @map("business_purpose")
  modelVersion    String    @default("nomic-v1.5-768") @map("model_version")
  embedding       Unsupported("vector(768)")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([repoId, entityId, modelVersion])
  @@index([orgId, repoId])
  @@index([taxonomy])
  @@index([featureTag])
  @@map("justification_embeddings")
  @@schema("unerr")
}

// Phase 5.5: Ledger snapshots â€” stores working-state file snapshots in PostgreSQL
model LedgerSnapshot {
  id              String    @id @default(uuid())
  orgId           String    @map("org_id")
  repoId          String    @map("repo_id")
  userId          String    @map("user_id")
  branch          String
  timelineBranch  Int       @map("timeline_branch")
  ledgerEntryId   String    @map("ledger_entry_id")
  reason          String
  files           Json      @default("[]")
  createdAt       DateTime  @default(now()) @map("created_at")

  repo            Repo      @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@index([orgId, repoId, branch])
  @@index([ledgerEntryId])
  @@map("ledger_snapshots")
  @@schema("unerr")
}

// Phase 5.5: Rule embeddings for anti-pattern vectorization (pgvector)
model RuleEmbedding {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  repoId        String    @map("repo_id")
  ruleId        String    @map("rule_id")
  ruleName      String    @map("rule_name")
  ruleType      String    @map("rule_type")
  textContent   String    @map("text_content")
  modelVersion  String    @default("nomic-v1.5-768") @map("model_version")
  embedding     Unsupported("vector(768)")
  matchedEntities String[] @map("matched_entities")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([repoId, ruleId, modelVersion])
  @@index([orgId, repoId])
  @@index([ruleType])
  @@map("rule_embeddings")
  @@schema("unerr")
}
